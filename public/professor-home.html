<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Professor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">
  <div class="container mt-5">
  <h1 class="mb-4 text-center">Your Theses</h1>
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle bg-white shadow-sm rounded">
      <thead class="table-dark">
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="professor-thesis-body">
  <!-- Rows will be dynamically added here -->
</tbody>
    </table>
  </div>
</div>
  <div class="container py-4">
    <h2 class="mb-4">Submit a New Thesis</h2>
    <form id="thesis-form" enctype="multipart/form-data" class="row g-3">
      <div class="col-12">
        <label for="thesis-title" class="form-label">Thesis Title</label>
        <input type="text" id="thesis-title" name="title" class="form-control" placeholder="Enter thesis title" required>
      </div>
      <div class="col-12">
        <label for="thesis-description" class="form-label">Thesis Description</label>
        <textarea id="thesis-description" name="description" class="form-control" rows="4" placeholder="Enter thesis description" required></textarea>
      </div>
      <div class="col-12">
        <label for="thesis-file" class="form-label">Upload PDF File</label>
        <input type="file" id="thesis-file" name="file" accept=".pdf" class="form-control" >
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary">Submit Thesis</button>
      </div>
    </form>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      fetch('/api/professor-theses')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const tbody = document.getElementById('professor-thesis-body');
            tbody.innerHTML = '';

            data.theses.forEach(thesis => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${thesis.title}</td>
                <td>${thesis.description}</td>
                <td>${thesis.status}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary edit-thesis" data-id="${thesis.id}">Edit</button>
                </td>
              `;
              tbody.appendChild(row);
            });

            // Add click event to each "Edit" button
            document.querySelectorAll('.edit-thesis').forEach(button => {
              button.addEventListener('click', (e) => {
                const thesisId = e.target.getAttribute('data-id');
                openEditForm(thesisId);
              });
            });
          } else {
            alert('Failed to fetch theses.');
          }
        })
        .catch(err => {
          console.error('Error fetching theses:', err);
          alert('An error occurred while fetching theses.');
        });
    });
  </script>


  <script>
  document.getElementById('thesis-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData();
    formData.append('title', document.getElementById('thesis-title').value);
    formData.append('description', document.getElementById('thesis-description').value);
    formData.append('file', document.getElementById('thesis-file').files[0]);

    try {
      const response = await fetch('/api/submit-thesis', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();
      if (response.ok) {
        alert('Thesis submitted successfully!');
        document.getElementById('thesis-form').reset();
      } else {
        alert(`Failed to submit thesis: ${result.message}`);
      }
    } catch (error) {
      console.error('Error submitting thesis:', error);
      alert('An error occurred while submitting the thesis.');
    }
  });
</script>



  <div class="container py-4">
    <h2 class="mb-4">Your Invitations</h2>
    <ul id="invite-list" class="list-group"></ul>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      // Check session
      const sessionRes = await fetch('/api/check-session');
      const sessionData = await sessionRes.json();
      if (!sessionData.loggedIn || sessionData.role !== 'professor') {
        return window.location.href = '/login.html';
      }

      const res = await fetch('/api/invites-for-me');
      const invites = await res.json();

      const list = document.getElementById('invite-list');
      invites.forEach(invite => {
        const li = document.createElement('li');
        li.className = 'list-group-item';

        li.innerHTML = `
          <strong>${invite.thesis_title}</strong> by <em>${invite.student}</em> - 
          <span class="badge bg-${invite.status === 'accepted' ? 'success' : invite.status === 'declined' ? 'danger' : 'secondary'} text-uppercase">${invite.status}</span>
        `;

        if (invite.status === 'pending') {
          const acceptBtn = document.createElement('button');
          acceptBtn.textContent = 'Accept';
          acceptBtn.className = 'btn btn-sm btn-success ms-3';
          acceptBtn.onclick = () => respondToInvite(invite.inviteId, 'accepted');

          const declineBtn = document.createElement('button');
          declineBtn.textContent = 'Decline';
          declineBtn.className = 'btn btn-sm btn-outline-danger ms-2';
          declineBtn.onclick = () => respondToInvite(invite.inviteId, 'declined');

          li.appendChild(acceptBtn);
          li.appendChild(declineBtn);
        }

        list.appendChild(li);
      });

      async function respondToInvite(inviteId, response) {
        const res = await fetch('/api/respond-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inviteId, response })
        });
        const data = await res.json();
        alert(data.message);
        location.reload(); // Refresh list
      }
    });
  </script>

<div id="edit-thesis-container" class="container mt-4 d-none">
  <h2 class="mb-4">Edit Thesis</h2>
  <form id="edit-thesis-form" class="row g-3">
    <input type="hidden" id="edit-thesis-id">
    <div class="col-12">
      <label for="edit-thesis-title" class="form-label">Thesis Title</label>
      <input type="text" id="edit-thesis-title" class="form-control" required>
    </div>
    <div class="col-12">
      <label for="edit-thesis-description" class="form-label">Thesis Description</label>
      <textarea id="edit-thesis-description" class="form-control" rows="4" required></textarea>
    </div>
    <div class="col-12 text-end">
      <button type="submit" class="btn btn-primary">Save Changes</button>
      <button type="button" class="btn btn-secondary" id="cancel-edit">Cancel</button>
    </div>
  </form>
</div>

<script>
function openEditForm(thesisId) {
  // Fetch thesis details
  fetch(`/api/thesis/${thesisId}`)
    .then(res => res.json())
    .then(data => {
      if (data) {
        // Populate the form fields with thesis details
        document.getElementById('edit-thesis-title').value = data.title;
        document.getElementById('edit-thesis-description').value = data.description;
        document.getElementById('edit-thesis-id').value = data.id;

        // Show the edit thesis container and hide the thesis table
        document.getElementById('edit-thesis-container').classList.remove('d-none');
        document.querySelector('.container.mt-5').classList.add('d-none');
      } else {
        alert('Failed to fetch thesis details.');
      }
    })
    .catch(err => {
      console.error('Error fetching thesis details:', err);
      alert('An error occurred.');
    });
}

// Handle form submission for editing thesis
document.getElementById('edit-thesis-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const thesisId = document.getElementById('edit-thesis-id').value;
  const title = document.getElementById('edit-thesis-title').value;
  const description = document.getElementById('edit-thesis-description').value;

  try {
    const res = await fetch(`/api/thesis/${thesisId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, description })
    });

    const result = await res.json();
    if (result.success) {
      alert('Thesis updated successfully!');
      location.reload(); // Reload the page to reflect changes
    } else {
      alert('Failed to update thesis.');
    }
  } catch (err) {
    console.error('Error updating thesis:', err);
    alert('An error occurred while updating the thesis.');
  }
});

// Cancel edit and go back to the thesis list
document.getElementById('cancel-edit').addEventListener('click', () => {
  document.getElementById('edit-thesis-container').classList.add('d-none');
  document.querySelector('.container.mt-5').classList.remove('d-none');
});
</script>

</body>
</html>
