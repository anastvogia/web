<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Professor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Professor Dashboard</a>
      <div class="d-flex align-items-center ms-auto">
        <span id="navbar-username" class="me-3 text-secondary fw-semibold"></span>
        <button id="logout-btn" class="btn btn-outline-danger btn-sm">Logout</button>
      </div>
    </div>
  </nav>
</head>

<script>
  // Fetch and display the current user's username
  window.addEventListener('DOMContentLoaded', () => {
    fetch('/api/check-session')
      .then(res => res.json())
      .then(data => {
        if (data.loggedIn) {
          document.getElementById('navbar-username').textContent = data.username;
        } else {
          window.location.href = '/login.html';
        }
      });

    // Handle logout
    document.getElementById('logout-btn').addEventListener('click', () => {
      fetch('/api/logout', { method: 'POST' })
        .then(() => window.location.href = '/login.html');
    });
  });
</script>
<body class="bg-light">
  <div class="container my-4">
    <h3>Assign Available Thesis to Student</h3>
  
    <div class="mb-3">
      <label for="thesis-select" class="form-label">Available Theses:</label>
      <select id="thesis-select" class="form-select"></select>
    </div>
  
    <div class="mb-3">
      <label for="student-select" class="form-label">Students without Thesis:</label>
      <select id="student-select" class="form-select"></select>
    </div>
  
    <button id="assign-btn" class="btn btn-primary">Assign Thesis</button>
  </div>
  
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const thesisSelect = document.getElementById('thesis-select');
    const studentSelect = document.getElementById('student-select');
  
    // Load theses
    const thesesRes = await fetch('/api/available-theses');
    const theses = await thesesRes.json();
  
    theses.forEach(thesis => {
      const option = document.createElement('option');
      option.value = thesis.id;
      option.textContent = `${thesis.title} (ID: ${thesis.id})`;
      thesisSelect.appendChild(option);
    });
  
    // Load students
    const studentsRes = await fetch('/api/students-without-thesis');
    const students = await studentsRes.json();
  
    students.forEach(student => {
      const option = document.createElement('option');
      option.value = student.id;
      option.textContent = `${student.username} (ID: ${student.id})`;
      studentSelect.appendChild(option);
    });
  
    // Handle assign button
    document.getElementById('assign-btn').addEventListener('click', async () => {
      const thesisId = thesisSelect.value;
      const studentId = studentSelect.value;
  
      if (!thesisId || !studentId) {
        return alert('Please select both a thesis and a student.');
      }
  
      const res = await fetch('/api/assign-thesis-to-student', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ thesisId, studentId })
      });
  
      const result = await res.json();
      alert(result.success ? 'Thesis assigned successfully!' : 'Failed to assign thesis.');
      if (result.success) {
        location.reload();
      }
    });
  });
  </script>
  <div class="container my-4">
    <h3>Students with Assigned Theses</h3>
    <table class="table table-bordered" id="assignment-table">
      <thead class="table-dark">
        <tr>
          <th>Student Username</th>
          <th>Thesis Title</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="assignment-body">
        <!-- Dynamic rows will be injected here -->
      </tbody>
    </table>
  </div>
  
  <!-- Bootstrap Modal for Confirm Cancellation -->
  <div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="confirmCancelModalLabel">Confirm Cancellation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to cancel this thesis assignment?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">No</button>
          <button type="button" id="confirm-cancel-btn" class="btn btn-danger btn-sm">Yes, Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch('/api/professor-assigned-theses');
    const assigned = await res.json();

    const assignmentBody = document.getElementById('assignment-body');
    assignmentBody.innerHTML = '';

    if (assigned.length === 0) {
      assignmentBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No students assigned yet.</td></tr>';
    } else {
      assigned.forEach(thesis => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${thesis.student_username}</td>
          <td>${thesis.title}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="cancelAssignment(${thesis.thesis_id})">
              Cancel
            </button>
          </td>
        `;
        assignmentBody.appendChild(row);
      });
    }
  } catch (err) {
    console.error('Error loading assigned theses:', err);
  }
});

// Cancel assignment
async function cancelAssignment(thesisId) {
  if (!confirm('Are you sure you want to cancel this assignment?')) return;

  try {
    const res = await fetch('/api/professor-cancel-assignment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ thesisId })
    });

    const result = await res.json();
    if (result.success) {
      window.location.reload();
      // Remove the row directly
      const row = document.getElementById(`row-${thesisId}`);
      if (row) row.remove();

      alert('Assignment cancelled successfully.');
    } else {
      alert('Failed to cancel assignment.');
    }
  } catch (err) {
    console.error('Error cancelling assignment:', err);
    alert('Server error during cancellation.');
  }
}

  </script>  
  
  <div class="container py-4">
    <h2 class="mb-4">Your Invitations</h2>
    <ul id="invite-list" class="list-group"></ul>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      // Check session
      const sessionRes = await fetch('/api/check-session');
      const sessionData = await sessionRes.json();
      if (!sessionData.loggedIn || sessionData.role !== 'professor') {
        return window.location.href = '/login.html';
      }

      const res = await fetch('/api/invites-for-me');
      const invites = await res.json();

      const list = document.getElementById('invite-list');
      invites.forEach(invite => {
        const li = document.createElement('li');
        li.className = 'list-group-item';

        li.innerHTML = `
          <strong>${invite.thesis_title}</strong> by <em>${invite.student}</em> - 
          <span class="badge bg-${invite.status === 'accepted' ? 'success' : invite.status === 'declined' ? 'danger' : 'secondary'} text-uppercase">${invite.status}</span>
        `;

        if (invite.status === 'pending') {
          const acceptBtn = document.createElement('button');
          acceptBtn.textContent = 'Accept';
          acceptBtn.className = 'btn btn-sm btn-success ms-3';
          acceptBtn.onclick = () => respondToInvite(invite.inviteId, 'accepted');

          const declineBtn = document.createElement('button');
          declineBtn.textContent = 'Decline';
          declineBtn.className = 'btn btn-sm btn-outline-danger ms-2';
          declineBtn.onclick = () => respondToInvite(invite.inviteId, 'declined');

          li.appendChild(acceptBtn);
          li.appendChild(declineBtn);
        }

        list.appendChild(li);
      });

      async function respondToInvite(inviteId, response) {
        const res = await fetch('/api/respond-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inviteId, response })
        });
        const data = await res.json();
        alert(data.message);
        location.reload(); // Refresh list
      }
    });
  </script>
</body>
</html>
